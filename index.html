<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Wiener Linien Live Monitor</title>
<style>
body { margin:0; background:#111; font-family:Arial,sans-serif; color:white; }
.container { width:900px; max-width:100%; margin:auto; padding:20px; }
.topbar { display:flex; justify-content:space-between; margin-bottom:20px; }
.weather, .clock { background:#222; padding:14px 28px; border-radius:12px; font-size:24px; }
.clock { font-size:26px; }
.title { text-align:center; margin-bottom:15px; }
.panel { background:#2b2b2b; border-radius:18px; padding:22px; }
.header-line { font-size:28px; margin-bottom:15px; font-weight:bold; }
.departure { display:flex; justify-content:space-between; align-items:center; padding:8px 14px; border-bottom:1px solid #444; border-radius:10px; margin-bottom:5px; transition: all 0.3s; }
.line-box { background:#d60000; padding:8px 18px; border-radius:10px; font-weight:bold; font-size:24px; }
.time { color:orange; font-size:32px; font-weight:bold; transition: color 0.3s; }
</style>
</head>
<body>
<div class="container">
    <div class="topbar">
        <div class="weather" id="weather">--°C Wien</div>
        <div class="clock" id="clock">--:--</div>
    </div>
    <div class="title">
        <h1>Wiener Linien</h1>
        <h2>U1 Oberlaa</h2>
    </div>
    <div class="panel">
        <div class="header-line">Nächste Ankünfte</div>
        <div class="departure"><div class="line-box">U1</div><div class="time" id="t1">--</div></div>
        <div class="departure"><div class="line-box">U1</div><div class="time" id="t2">--</div></div>
        <div class="departure"><div class="line-box">U1</div><div class="time" id="t3">--</div></div>
        <div class="departure"><div class="line-box">U1</div><div class="time" id="t4">--</div></div>
    </div>
</div>

<script>
// -------- Uhr --------
function updateClock() {
    const now = new Date();
    document.getElementById("clock").innerText =
        String(now.getHours()).padStart(2,"0") + ":" +
        String(now.getMinutes()).padStart(2,"0");
}
updateClock();
setInterval(updateClock, 1000);

// -------- Wetter --------
async function updateWeather(){
    try{
        const r = await fetch("https://api.open-meteo.com/v1/forecast?latitude=48.2&longitude=16.37&current_weather=true");
        const d = await r.json();
        document.getElementById("weather").innerText = d.current_weather?.temperature !== undefined ?
            Math.round(d.current_weather.temperature)+"°C Wien" : "--°C Wien";
    }catch{ document.getElementById("weather").innerText="--°C Wien"; }
}
updateWeather();
setInterval(updateWeather, 5*60*1000);

// -------- Abfahrten in Minuten --------
function calcMinutesUntil(planned){
    const match = planned.match(/T(\d{2}):(\d{2})/);
    if(!match) return null;
    const now = new Date();
    const nowMin = now.getHours()*60 + now.getMinutes();
    const targetMin = parseInt(match[1])*60 + parseInt(match[2]);
    const diff = targetMin - nowMin;
    return diff>=0 ? diff : null;
}

async function updateTimes(){
    try{
        // URL zu deinem Proxy anpassen
        const res = await fetch("http://DEIN_SERVER:3000/getDepartures");
        const data = await res.json();
        const lines = data.data?.monitors?.[0]?.lines || [];
        const u1 = lines.find(l=>l.name==="U1");
        const deps = u1?.departures?.departure || [];

        for(let i=0;i<4;i++){
            const dep = deps[i];
            const el = document.getElementById("t"+(i+1));
            if(!dep?.departureTime?.timePlanned){
                el.innerText="--";
                el.style.color = "orange";
                continue;
            }
            const diff = calcMinutesUntil(dep.departureTime.timePlanned);
            if(diff !== null){
                el.innerText = diff + " Min";
                el.style.color = diff <= 2 ? "red" : "orange"; // <3 Min rot
            } else {
                el.innerText="--";
                el.style.color="orange";
            }
        }
    } catch(e){
        console.log("Fehler Abfahrten", e);
        for(let i=1;i<=4;i++){
            const el = document.getElementById("t"+i);
            el.innerText="--";
            el.style.color="orange";
        }
    }
}
updateTimes();
setInterval(updateTimes,10000);
</script>
</body>
</html>
